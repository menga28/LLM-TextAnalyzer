<source>
  @type tail
  path ../datasets/content.xml
  pos_file /fluentd/log/content.pos
  tag dataset.content
  
  <parse>
    @type xml
    xpath //*
  </parse>
</source>

<source>
  @type tail
  path ../datasets/query.xml
  pos_file /fluentd/log/query.pos
  tag dataset.query
  
  <parse>
    @type xml
    xpath //question/question
  </parse>
</source>

<source>
  @type tail
  path ../datasets/result.xml
  pos_file /fluentd/log/result.pos
  tag dataset.result
  
  <parse>
    @type xml
    xpath //results/result
  </parse>
</source>

# Aggiungi un filtro per aggiungere un timestamp predefinito
<filter dataset.content>
  @type record_transformer
  <record>
    time ${time.now}  # Aggiunge un timestamp predefinito
    uuid ${uuid}
    title ${title}
    abstract ${abstract}
    query ${query}
  </record>
</filter>

<filter dataset.query>
  @type record_transformer
  <record>
    time ${time.now}  # Aggiunge un timestamp predefinito
    id ${id}
    text ${text}
  </record>
</filter>

<filter dataset.result>
  @type record_transformer
  <record>
    time ${time.now}  # Aggiunge un timestamp predefinito
    content_id ${record["content_id"]}
    answers ${record["answers"]}
  </record>
</filter>

# Match per il file content.xml
<match dataset.content>
  @type http
  endpoint http://arangodb:8529/_api/import?collection=content
  http_method post
  format json

  <buffer>
    @type memory
    flush_interval 5s
    chunk_limit_size 1MB
  </buffer>

  <format>
    @type json
    <record>
      uuid ${uuid}
      title ${title}
      abstract ${abstract}
      query ${query}
      time ${time}  # Include il timestamp
    </record>
  </format>
</match>

# Match per il file query.xml
<match dataset.query>
  @type http
  endpoint http://arangodb:8529/_api/import?collection=query
  http_method post
  format json

  <buffer>
    @type memory
    flush_interval 5s
    chunk_limit_size 1MB
  </buffer>

  <format>
    @type json
    <record>
      id ${id}
      text ${text}
      time ${time}  # Include il timestamp
    </record>
  </format>
</match>

# Match per il file result.xml
<match dataset.result>
  @type http
  endpoint http://arangodb:8529/_api/import?collection=result
  http_method post
  format json
  
  <buffer>
    @type memory
    flush_interval 5s
  </buffer>
  
  <format>
    @type json
    <record>
      content_id ${record["content_id"]}
      answers ${record["answers"]}
      time ${time}  # Include il timestamp
    </record>
  </format>
</match>
